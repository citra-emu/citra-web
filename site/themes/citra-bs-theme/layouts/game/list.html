{{ define "main" }}
	<h1>Game Compatibility List</h1>
	<p>The Citra Emulator compatibility list contains all the games we tested, sorted by how well they work on the emulator.</p>
	<table class="table table-striped table-bordered">
		<tbody>
		{{ range .Site.Data.compatibility }}
        <tr>
			<td style="width: 120px;"><div class="square-icon" style="background-color: {{ .color }}"></div> {{ .name }}</td>
			<td class="row-compat-desc">{{ .description }}</td>
		</tr>
		{{ end }}
		</tbody>
	</table>

	<div id="highchart-container" style="height: 100px; margin: 0 auto"></div>

	<hr />

	<div id="game-sections">
		<div class="btn-group" role="group">
			<a class="btn btn-secondary" href="##">#</a>
			{{ range (seq 'a' 'z') }}
			<a class="btn btn-secondary" href="#{{ printf "%c" . }}">{{ printf "%c" . }}</a>
			{{ end }}
		</div>
	</div>

	<table id="compatibility-list" class="table table-responsive">
		<thead>
			<tr>
				<th></th>
				<th>Title</th>
				<th>Type</th>
				<th>Compatibility</th>
				<th>Date Tested</th>
			</tr>
		</thead>
		<tbody>
		{{ range .Data.Pages.GroupByParam "section_id" }}
			<tr>
				<td id="game-section-header">
					<h3 id="{{ .Key }}">{{ .Key }}</h3>
				</td>
			</tr>

			{{ range .Pages }}
			  {{- $rating := index .Site.Data.compatibility .Params.compatibility }}
				{{- $type := index .Site.Data.gameTypes (.Params.game_type | default "3ds") }}
				<tr data-compatibility="{{ $rating.name }}">
	        <td class="col-md-1"><img src="{{ .Site.BaseURL }}images/game/icons/{{ .File.BaseFileName }}.png" /></td>
	        <td class="col-md-6"><a href="{{ .Permalink }}">{{ .Params.title }}</a></td>
					<td class="col-md-1"><img src="{{ .Site.BaseURL }}images/game/types/{{ $type.key }}.png" title="{{ $type.name }}" /></td>
					<td class="col-md-1"><div class="square-icon" style="background-color: {{ $rating.color }}"></div> {{ $rating.name }}</td>
	        <td class="col-md-3">{{ dateFormat "January 2, 2006" .Params.testcase_date }}</td>
	      </tr>
			{{ end }}
		{{ end }}
		</tbody>
	</table>
{{ end }}

{{ define "scripts" }}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script type="text/javascript">
function filterTable(e){
    var compatMap = {0: 'Perfect', 1: 'Great', 2: 'Okay', 3: 'Bad', 4: 'Intro/Menu', 5: 'Won\'t Boot', 6: 'Not Tested'};
    var className = Array.prototype.filter.call(e.target.classList, function(className){
        return className.startsWith('highcharts-color-');
    })[0];
    var colorNum = className.slice(-1);

    //If clicked on a new color, hides all other colors
    if (colorNum != window.lastClicked){
        clearFilter();
        window.lastClicked = colorNum;
        var chart = $("#highchart-container").highcharts()
        window.clearButton = chart.renderer.button('Clear', null, null, function(){ clearFilter() }, {
            zIndex: 20
        }).attr({
            align: 'right',
            title: 'Clear compatibility filter'
        }).add().align({
            align: 'right',
            x: -16,
            y: 18
        }, false, null);

        $("#compatibility-list tbody tr[data-compatibility][data-compatibility!=\"" + compatMap[colorNum] + "\"]").css('display', 'none');

        //Checks if section headers are empty and hides them if they are
        $("#compatibility-list tbody tr:not([data-compatibility])").each(function(){
            var elements = $(this).nextUntil("#compatibility-list tbody tr:not([data-compatibility])").filter(function(){
                return $(this).css('display') != 'none';
            });
            var containsVisible = !!elements.length;
            if (!containsVisible)
                $(this).css('display', 'none');
        })
    } else {
        clearFilter();
    }
}
function clearFilter(){
    $("#compatibility-list tbody tr").css('display', '');
    if (window.clearButton){
        window.clearButton.destroy();
        window.clearButton = undefined;
        window.lastClicked = undefined;
    }
}

Highcharts.chart('highchart-container', {
    chart: { type: 'bar' },
    colors: [{{ range .Site.Data.compatibility }}"{{ .color }}", {{- end }}],
    credits: { enabled: false },
		exporting: { enabled: false },
    title: { text: '' },
    xAxis: { categories: [''] },
    yAxis: { min: 0, max: {{ len .Data.Pages }}, title: { text: '' } },
    legend: { enabled: false },
    plotOptions: { series: {
        stacking: 'normal',
        cursor: 'pointer',
        events: {
            click: filterTable
        }
    } },
    series: [
			{{- $dataPages := .Data.Pages }}
			{{- range .Site.Data.compatibility }}
			{{- $dataPagesFiltered := where $dataPages ".Params.compatibility" .key }}
			{ "name": "{{ .name }}", "data": [ {{ len $dataPagesFiltered }} ] },
			{{- end }}
		]
});
</script>
{{ end }}
